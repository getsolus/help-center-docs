<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Intro to Optimizing Packages on Solus | Solus Help Center</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://help.getsol.us/img/logo.jpg><meta data-rh=true name=twitter:image content=https://help.getsol.us/img/logo.jpg><meta data-rh=true property=og:url content=https://help.getsol.us/blog/solus-optimizing-packages><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true property=og:title content="Intro to Optimizing Packages on Solus | Solus Help Center"><meta data-rh=true name=description content="Explore how to employ advanced compiler techniques such as PGO, BOLT & Glibc HWCaps to squeeze extra performance from packages using libwebp as a test vehicle"><meta data-rh=true property=og:description content="Explore how to employ advanced compiler techniques such as PGO, BOLT & Glibc HWCaps to squeeze extra performance from packages using libwebp as a test vehicle"><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2024-02-09T00:00:00.000Z><meta data-rh=true property=article:tag content=pgo,lto,solus,packaging,optimization,3,clang,gnu,llvm,glibc,hwcaps,x86_64-v3><link data-rh=true rel=icon href=/img/support-icon-2.svg><link data-rh=true rel=canonical href=https://help.getsol.us/blog/solus-optimizing-packages><link data-rh=true rel=alternate href=https://help.getsol.us/blog/solus-optimizing-packages hreflang=en><link data-rh=true rel=alternate href=https://help.getsol.us/blog/solus-optimizing-packages hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://help.getsol.us/blog/solus-optimizing-packages","@type":"BlogPosting","author":{"@type":"Person","description":"Solus Staff","image":"https://avatars.githubusercontent.com/u/5338090","name":"Joey Riches"},"datePublished":"2024-02-09T00:00:00.000Z","description":"Explore how to employ advanced compiler techniques such as PGO, BOLT & Glibc HWCaps to squeeze extra performance from packages using libwebp as a test vehicle","headline":"Intro to Optimizing Packages on Solus","isPartOf":{"@id":"https://help.getsol.us/blog","@type":"Blog","name":"Solus DevLog"},"keywords":[],"mainEntityOfPage":"https://help.getsol.us/blog/solus-optimizing-packages","name":"Intro to Optimizing Packages on Solus","url":"https://help.getsol.us/blog/solus-optimizing-packages"}</script><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="Solus Help Center RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="Solus Help Center Atom Feed"><link rel=stylesheet href=/assets/css/styles.6ecb6ee1.css><script src=/assets/js/runtime~main.d80968e0.js defer></script><script src=/assets/js/main.69788a59.js defer></script><body class=navigation-with-keyboard data-theme=light><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="Solus Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo.svg alt="Solus Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Solus Help Center</b></a><a class="navbar__item navbar__link" href=/docs/user/intro>Users</a><a class="navbar__item navbar__link" href=/docs/packaging/>Packaging</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/blog>Dev Log</a><div class="navbar__item dropdown dropdown--hoverable"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link>More</a><ul class=dropdown__menu><li><a href=https://getsol.us target=_blank rel="noopener noreferrer" class=dropdown__link>Solus Homepage<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://discuss.getsol.us/ target=_blank rel="noopener noreferrer" class=dropdown__link>Forums<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://matrix.to/#/#solus:matrix.org target=_blank rel="noopener noreferrer" class=dropdown__link>Matrix<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://fosstodon.org/@Solus target=_blank rel="noopener noreferrer" class=dropdown__link>Mastodon<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://github.com/getsolus target=_blank rel="noopener noreferrer" class=dropdown__link>Github<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://dev.getsol.us/ target=_blank rel="noopener noreferrer" class=dropdown__link>Packages<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://issues.getsol.us/ target=_blank rel="noopener noreferrer" class=dropdown__link>Issue Tracker<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li><a href=https://github.com/getsolus/packages/blob/main/SECURITY.md target=_blank rel="noopener noreferrer" class=dropdown__link>Security<svg width=12 height=12 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=dsla-search-wrapper><div class=dsla-search-field data-tags=default,docs-default-current></div></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_rMGB>2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/blog/clean-clean-clean>Clean, clean, clean!</a><li class=sidebarItem__DBe><a aria-current=page class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href=/blog/solus-optimizing-packages>Intro to Optimizing Packages on Solus</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href="/blog/don't-call-me-mate-pal">Don't call me MATE, pal!</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/blog/eopkg-is-dead-long-live-eopkg>eopkg is dead, long live eopkg</a><li class=sidebarItem__DBe><a class=sidebarItemLink_mo7H href=/blog/welcome-solus-devlog-v1>Welcome to the Solus Devlog</a></ul></div></nav></aside><main class="col col--7"><article><header><h1 class=title_f1Hy>Intro to Optimizing Packages on Solus</h1><div class="container_mt6G margin-vert--md"><time datetime=2024-02-09T00:00:00.000Z>February 9, 2024</time> · <!-- -->23 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class=avatar__photo-link href=/blog/authors/joey><img class="avatar__photo authorImage_XqGP" src=https://avatars.githubusercontent.com/u/5338090 alt="Joey Riches"></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=/blog/authors/joey><span class=authorName_yefp>Joey Riches</span></a></div><small class=authorTitle_nd0D title="Solus Staff">Solus Staff</small><div class=authorSocials_rSDt><a href=https://github.com/joebonrichie target=_blank rel="noopener noreferrer" class=authorSocialLink_owbf title=GitHub><svg viewBox="0 0 256 250" width=1em height=1em class="authorSocialLink_owbf githubSvg_Uu4N" style=--dark:#000;--light:#fff preserveAspectRatio=xMidYMid><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"/></svg></a></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>We'll explore how to build packages with advanced compiler techniques in order to squeeze more performance out of the box for packages in Solus. We'll be using the story of how <code>libwebp</code> was optimized for and how it led to an unexpected side quest.</p>
<p>Linux distributions have a lot of control over how a source-based package gets compiled and shipped to users as part of a binary repository. Aggressive and advanced compiler optimization techniques, as well as other methods can be used to provide greater out of the box performance for end users. This can greatly benefit users running on older hardware to provide a snappier end-user experience; reducing time waiting on a heavy workload to finish; or even improved battery life; amongst other improvements.</p>
<p>Part of the problem is, a packager's time is limited. So how, as a distribution, do you choose to try provide faster compatible packages for an end user. A historic approach is to simply change the default compiler flags for <em>all</em> packages, such as enabling <a href=https://en.wikipedia.org/wiki/Interprocedural_optimization target=_blank rel="noopener noreferrer">LTO</a> by default. Whilst this approach can work well, at Solus the philosophy is slightly different where a packager can trivially enable several advanced compiler optimization techniques such as <a href=https://en.wikipedia.org/wiki/Profile-guided_optimization target=_blank rel="noopener noreferrer">PGO</a> without too much faffing around on a <em>targeted</em> package.</p>
<p>The benefits of such an approach are:</p>
<ul>
<li>Can target the performance of a specific package to benefit <em>all</em> users</li>
<li>A compiler optimization may improve one package, but may not apply globally to all packages.</li>
</ul>
<p>The downsides are such:</p>
<ul>
<li>Requires additional packager time to benchmark and experiment with different optimization strategies.</li>
<li>Requires the packager to <em>choose</em> and invest time into improving performance of a package.</li>
<li>Requires the packager to find an appropriate benchmark to test the package against.</li>
<li>Experimenting with compiler optimizations may not bear fruit: no meaningful improvement in performance, or there may be some other bottleneck.</li>
</ul>
<h1>Optimization Techniques Available</h1>
<ul>
<li>speed:<!-- -->
<ul>
<li>As simple as it gets really, build a package with <code>-O3</code> instead of <code>-O2</code> as well as any other flags deemed worthy to be included as part of the <code>speed</code> flags. The main drawback of this is that <code>-O3</code> is not guaranteed to produce faster results than building with <code>-O2</code> and typically will produce bigger binaries. The days of <code>-O3</code> outright breaking your program in weird unexpected ways is largely behind us.</li>
</ul>
</li>
<li>LTO:<!-- -->
<ul>
<li>Compared to some other distributions <code>-flto</code> is not yet enabled by default on Solus. LTO is almost guaranteed to provide a %1 or slightly larger performance improvement as well as a smaller binary at the cost of increased compiling times and memory usage during build. When combined with other optimization techniques such as PGO the LTO optimization can really stretch its legs and provide even greater uplift!</li>
</ul>
</li>
<li>Clang:<!-- -->
<ul>
<li>Not strictly an optimization, but, building a package with <code>clang</code> instead of <code>gcc</code> and <code>ld.ldd</code> to link instead of the infamous <code>ld.bfd</code> may provide a faster package out of the box. You'll have to be careful of subtle ABI differences if building with <code>clang</code>. If in doubt, and, <code>clang</code> is the obvious choice, perform safety rebuilds on all reverse dependencies of the package.</li>
</ul>
</li>
<li>PGO:<!-- -->
<ul>
<li>Profile guided optimization. Build once with instrumentation in order to collect profile data when ran. Run the program using a representative workload in order to collect profiling data. Build the program again with the profiling data provided in order to build an optimized variant.</li>
</ul>
</li>
<li>BOLT:<!-- -->
<ul>
<li>Binary optimization and layout tool. You can think of this as "post-link PGO" where you instrument a binary with <code>bolt</code> to collect profiling data. Run that binary. Then finally reorganize the binary layout using the collected profile data. This generally works better on large statically linked binaries but smaller binaries or libraries such as found in a typical package can benefit too. This optimization is still quite new.</li>
</ul>
</li>
</ul>
<p>Regardless, that's enough word spaghetti, let's look at the process to actually optimize a package.</p>
<h1>Optimizing a Package</h1>
<p>Right, to begin with we'll have to start on choosing an actual package to benchmark and optimize. I've heard the <code>.webp</code> file format is becoming increasingly common on the web, slowly replacing <code>.png</code> and <code>.jpg</code> file formats due to the strong backing of Google (for better or for worst). An improvement in decoding time for <code>.webp</code> files would benefit any user using a web browser casually browsing the web.</p>
<p>Let's have a look at the <code>package.yml</code> build recipe for <code>libwebp</code>.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>name</span><span class="token plain">       </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> libwebp</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>version</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 1.3.2</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>release</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>25</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>source</span><span class="token plain">     </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token key atrule" style=color:#00a4db>https://github.com/webmproject/libwebp/archive/refs/tags/v1.3.2.tar.gz</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> c2c2f521fa468e3c5949ab698c2da410f5dce1c5e99f5ad9e70e0e8446b86505</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>homepage</span><span class="token plain">   </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> https</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">//developers.google.com/speed/webp/</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>license</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> BSD</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">3</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">Clause</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>component</span><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> multimedia.codecs</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>summary</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> A new image format for the web</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>description</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    WebP is a new image format that provides lossless and lossy compression for images on the web. WebP lossless images are 26% smaller in size compared to PNGs. WebP lossy images are 25-34% smaller in size compared to JPEG images at equivalent SSIM index. WebP supports lossless transparency (also known as alpha channel) with just 22% additional bytes. Transparency is also supported with lossy compression and typically provides 3x smaller file sizes compared to PNG when lossy compression is acceptable for the red/green/blue color channels.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>emul32</span><span class="token plain">     </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> yes</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>patterns</span><span class="token plain">   </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token key atrule" style=color:#00a4db>devel</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> /usr/share/man</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>builddeps</span><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(glu)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(glut)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(libpng)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(libtiff</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">4)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(libturbojpeg)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> pkgconfig32(zlib)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> giflib</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">devel</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>setup</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %reconfigure --disable-static --enable-everything</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>build</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %make</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>install</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %make_install</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Okay, looks to be a quite simple affair. A simple configure, make, make install as well as <code>emul32</code> being enabled specifying the -32bit packages are also provided from this recipe. Next step is to look for a repeatable and easy way to benchmark it. We'll begin by looking at the <code>pspec_x86_64.xml</code> file which lists all the files produced from the <code>package.yml</code> recipe as well as some metadata.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Name</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">libwebp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Name</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Summary</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name namespace" style=color:#00a4db;opacity:0.7>xml:</span><span class="token tag attr-name" style=color:#00a4db>lang</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>en</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">A new image format for the web</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Summary</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Description</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name namespace" style=color:#00a4db;opacity:0.7>xml:</span><span class="token tag attr-name" style=color:#00a4db>lang</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>en</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">WebP is a new image format that provides lossless and lossy compression for images on the web. WebP lossless images are 26% smaller in size compared to PNGs. WebP lossy images are 25-34% smaller in size compared to JPEG images at equivalent SSIM index. WebP supports lossless transparency (also known as alpha channel) with just 22% additional bytes. Transparency is also supported with lossy compression and typically provides 3x smaller file sizes compared to PNG when lossy compression is acceptable for the red/green/blue color channels.</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Description</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>PartOf</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">multimedia.codecs</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>PartOf</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Files</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/cwebp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/dwebp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/gif2webp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/img2webp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/vwebp</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/webpinfo</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token tag punctuation" style=color:#393A34>&lt;</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag" style=color:#00009f> </span><span class="token tag attr-name" style=color:#00a4db>fileType</span><span class="token tag attr-value punctuation attr-equals" style=color:#393A34>=</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag attr-value" style=color:#e3116c>executable</span><span class="token tag attr-value punctuation" style=color:#393A34>"</span><span class="token tag punctuation" style=color:#393A34>></span><span class="token plain">/usr/bin/webpmux</span><span class="token tag punctuation" style=color:#393A34>&lt;/</span><span class="token tag" style=color:#00009f>Path</span><span class="token tag punctuation" style=color:#393A34>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Perfect, we have <code>dwebp</code> and <code>cwebp</code> binaries available in the main package, which from a guess can be used to decode and encode <code>.webp</code> files. Let's try it out.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ dwebp -h</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Usage: dwebp in_file [options] [-o out_file]</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Decodes the WebP image file to PNG format [Default].</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Note: Animated WebP files are not supported.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ cwebp -h</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Usage:</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">   cwebp [options] -q quality input.png -o output.webp</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Awesome, these binaries do exactly what we need to benchmark <code>libwebp</code>, but, we are also indirectly testing <code>libpng</code> as well for this benchmark, we'll have to keep an eye out for that.</p>
<p>One extra step we have to do is ensure these binaries are actually linking against their own library, as upstream developers can have a habit of making sure their binaries don't link against their own libraries and end up being self-contained. Run <code>ldd</code> to verify.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ ldd /usr/bin/dwebp</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	linux-vdso.so.1 (0x00007ffed8733000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libwebpdemux.so.2 => /usr/lib/libwebpdemux.so.2.0.14 (0x00007f7473bb4000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libwebp.so.7 => /usr/lib/libwebp.so.7.1.8 (0x00007f7473ae2000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libpng16.so.16 => /usr/lib/libpng16.so.16 (0x00007f7473aa6000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libc.so.6 => /usr/lib/glibc-hwcaps/x86-64-v3/libc.so.6 (0x00007f74738a9000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libsharpyuv.so.0 => /usr/lib/libsharpyuv.so.0.0.1 (0x00007f747389e000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libm.so.6 => /usr/lib/glibc-hwcaps/x86-64-v3/libm.so.6 (0x00007f74737b8000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libz.so.1 => /usr/lib/libz.so.1.3.0 (0x00007f7473200000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	/usr/lib64/ld-linux-x86-64.so.2 (0x00007f7473bea000)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Awesome in this case both <code>dwebp</code> and <code>cwebp</code> link against <code>libwebp.so</code> so we can be confident that any performance improvements will be applicable to all packages in the repository linking against <code>libwebp</code>.</p>
<p>Let's grab a couple of <code>.webp</code> files from <a href=https://developers.google.com/speed/webp/gallery1 target=_blank rel="noopener noreferrer">here</a> to test with. We'll just use the largest image size available in this case to reduce noise as much as possible when running benchmarks as well as allow any potential optimizations to stretch their legs a little more.</p>
<p>Now having done the prep work, lets actually benchmark the damn thing using <code>hyperfine</code> for the time being.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):     202.2 ms ±   0.3 ms    [User: 198.9 ms, System: 3.0 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):   201.8 ms … 202.7 ms    14 runs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "cwebp ~/PNG_Test.png -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: cwebp ~/PNG_Test.png -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):      1.423 s ±  0.009 s    [User: 1.346 s, System: 0.076 s]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):    1.410 s …  1.435 s    10 runs</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>There, we have our a basic baseline for encode and decode performance. We mostly care about decode performance here but improved encoding performance would also not go amiss.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=lets-start-obvious>Let's Start Obvious<a href=#lets-start-obvious class=hash-link aria-label="Direct link to Let's Start Obvious" title="Direct link to Let's Start Obvious">​</a></h2>
<p>Let's start basic, enabling the <code>speed</code> optimization which basically builds with <code>-O3</code> instead of <code>-O2</code> as well as any other flags that are deemed to be worthy to be part of the <code>speed</code> group. As well as, the <code>lto</code> optimization which builds with link time optimization allowing for inter-procedural optimizations to take place.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>optimize</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> speed</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> lto</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Moment of truth...</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):     200.0 ms ±   1.5 ms    [User: 197.3 ms, System: 2.5 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):   198.1 ms … 203.2 ms    15 runs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "cwebp ~/PNG_Test.png -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: cwebp ~/PNG_Test.png -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):      1.353 s ±  0.012 s    [User: 1.281 s, System: 0.071 s]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):    1.336 s …  1.369 s    10 runs</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Well okay, we got a very minor uplift in decoding performance and a slightly higher improvement in encoding performance, but nothing too much to write home about. Luckily we have several more optimizations to explore...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=pgo-is-great-except-when-it-isnt>PGO is great, except, when it isn't.<a href=#pgo-is-great-except-when-it-isnt class=hash-link aria-label="Direct link to PGO is great, except, when it isn't." title="Direct link to PGO is great, except, when it isn't.">​</a></h2>
<p>Next step is to explore PGO (Profile Guided Optimization). For our <code>libwebp</code> package, looks like we already hit a bit of a snafu. There's no test suite included in the tarball! That's a bit of a disappointment as a test suite such as <code>make check</code> is by far and away the easiest and most comprehensive workload that can be used for profiling as part of PGO, especially for smaller libraries. However, we can still experiment with the just built <code>dwebp</code> and <code>cwebp</code> binaries as a suitable workload for PGO.</p>
<p>Luckily, as part of the package.yml format all you have to do is provide a profile for automatic PGO. After chrooting into the build environment and fiddling around a bit we end up with:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>profile</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    ./examples/dwebp webp_js/test_webp_js.webp -o test_png.png</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    ./examples/cwebp test_png.png -o /dev/null</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>After specifying that, 6 builds will now be performed instead of 2:</p>
<ul>
<li>emul32:<!-- -->
<ul>
<li>Instrumented build</li>
<li>Run profiling workload</li>
<li>Optimized build using profiling data</li>
</ul>
</li>
<li>x86_64:<!-- -->
<ul>
<li>Instrumented build</li>
<li>Run profiling workload</li>
<li>Optimized build using profiling data</li>
</ul>
</li>
</ul>
<p>For this relatively small package it increases the build time from 1m1.672s to 1m42.199s</p>
<p>The next moment of truth...</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):     204.1 ms ±   2.2 ms    [User: 201.3 ms, System: 2.7 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):   201.6 ms … 207.1 ms    14 runs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "cwebp ~/PNG_Test.png -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: cwebp ~/PNG_Test.png -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):      1.349 s ±  0.010 s    [User: 1.266 s, System: 0.082 s]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):    1.335 s …  1.374 s    10 runs</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Well... That's interesting. We actually regress in performance for decode performance whilst gaining another small bump in encoding performance. Worse still, we get a bunch of <code>profile count data file not found [-Wmissing-profile]</code> warning messages during the optimized build indicating to us our profiling workload isn't comprehensive enough and doesn't cover enough code paths. The lack of a handy <code>make check</code> that could be used as a profiling workload is really hurting us here. For now, let's put a pin in exploring PGO, it isn't a dead end but more work needs to be done curating a more comprehensive workload to chuck at it in this particular case, whilst other, easier, optimization techniques are still available to us.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=256-vector-units-go-brrrrrr>256 Vector Units go brrrrrr...<a href=#256-vector-units-go-brrrrrr class=hash-link aria-label="Direct link to 256 Vector Units go brrrrrr..." title="Direct link to 256 Vector Units go brrrrrr...">​</a></h2>
<p>The next obvious step is to explore <code>glibc</code> hardware capabilities. For those unaware both <code>clang</code> and <code>gnu</code> compilers provide <code>x86_64-v2</code>, <code>x86_64-v3</code> and <code>x86_64-v4</code> micro-architecture build options on top of the baseline of <code>x86_64</code>. These enable the use of targeting additional CPU instruction sets during compilation for better performance. For example, <code>-sse4.2</code> for <code>x86_64-v2</code>, <code>-avx2</code> for <code>x86_64-v3</code>, and <code>-avx512</code> for <code>x86_64-v4</code>.</p>
<p>Whilst that's great 'n all, if a program is built with <code>x86_64-v3</code> and gains an additional ~10% uplift in performance, it's no good if a <code>x86_64-v2</code> compatible cpu can't run it. Luckily the <code>glibc</code> loader that's found on almost general purpose linux installs provides a way to load higher or lower micro-architecture libraries if they're installed and supported.</p>
<p>On top of all that, the <code>package.yml</code> format provides an incredibly simple way of providing <code>x86_64-v3</code> built libraries by enabling the <code>avx2 : yes</code> flag.</p>
<p>With <code>avx2 : yes</code> enabled in the <code>libwebp</code> package three builds are performed.</p>
<ul>
<li>emul32</li>
<li>x86_64-v3</li>
<li>x86_64</li>
</ul>
<p>We now see these additional files in the <code>pspec_x86_64.xml</code> file</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libsharpyuv.so.0&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libsharpyuv.so.0.0.1&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebp.so.7&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebp.so.7.1.8&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpdecoder.so.3&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpdecoder.so.3.1.8&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpdemux.so.2&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpdemux.so.2.0.14&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpmux.so.3&lt;/Path></span><br></span><span class=token-line style=color:#393A34><span class="token inserted-sign inserted line" style=color:#36acaa></span><span class="token inserted-sign inserted prefix inserted" style=color:#36acaa>+</span><span class="token inserted-sign inserted line" style=color:#36acaa>            &lt;Path fileType="library">/usr/lib64/glibc-hwcaps/x86-64-v3/libwebpmux.so.3.0.13&lt;/Path></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Let's rerun <code>lld</code> on <code>dwebp</code> after installing the new package and...</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ ldd /usr/bin/dwebp</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	linux-vdso.so.1 (0x00007ffeab5b1000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libwebpdemux.so.2 => /usr/lib/glibc-hwcaps/x86-64-v3/libwebpdemux.so.2.0.14 (0x00007f9a351d5000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libwebp.so.7 => /usr/lib/glibc-hwcaps/x86-64-v3/libwebp.so.7.1.8 (0x00007f9a3510b000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libpng16.so.16 => /usr/lib/libpng16.so.16 (0x00007f9a350cf000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libc.so.6 => /usr/lib/glibc-hwcaps/x86-64-v3/libc.so.6 (0x00007f9a34ed2000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libsharpyuv.so.0 => /usr/lib/glibc-hwcaps/x86-64-v3/libsharpyuv.so.0.0.1 (0x00007f9a34ec1000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libm.so.6 => /usr/lib/glibc-hwcaps/x86-64-v3/libm.so.6 (0x00007f9a34ddb000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	libz.so.1 => /usr/lib/glibc-hwcaps/x86-64-v3/libz.so.1.3 (0x00007f9a34dbb000)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	/usr/lib64/ld-linux-x86-64.so.2 (0x00007f9a3520b000)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>We can crucially see that <code>dwebp</code> is now loading the <code>x86-64-v3</code> built <code>libwebp.so</code> lib from <code>/usr/lib/glibc-hwcaps/x86-64-v3/libwebp.so.7.1.8</code>, success! Let's what our performance looks like.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):     198.2 ms ±   1.2 ms    [User: 195.4 ms, System: 2.5 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):   197.0 ms … 200.5 ms    14 runs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "cwebp ~/PNG_Test.png -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: cwebp ~/PNG_Test.png -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):      1.313 s ±  0.009 s    [User: 1.243 s, System: 0.078 s]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):    1.308 s …  1.341 s    10 runs</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Let's recap so far:</p>
<table><thead><tr><th>Optimization<th>Decode<th>Encode<th>Size<tbody><tr><td>Baseline<td>202.2 ms<td>1.399 s<td>1.33 MB<tr><td>Speed + LTO<td>200.0 ms<td>1.353 s<td>1.73 MB<tr><td>Speed + LTO + PGO<td>204.1 ms <!-- -->⚠️<td>1.349 s<td>1.07 MB<tr><td>Speed + LTO + x86_64-v3<td>198.2 ms<td>1.313 s<td>3.17 MB</table>
<p>Whilst we're still getting an additional speedup it isn't really anything to write home about. A measly ~2% improvement in decoding performance and a fairly respectable ~7% improvement in encoding performance for our test case. However, increasing the package size by an extra ~2MiB from providing a bunch of extra libs in <code>/usr/lib/glibc-hwcaps/x86-64-v3/</code> just ain't worth it. This hints that either the compiler optimizations aren't really effective here or we're being bottle-necked by something else.</p>
<p>So far, we've been benchmarking fairly simply using <code>hyperfine</code>, let's swap that out for <code>perf</code> so we can get a callgraph.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=something-about-perf-to-the-rescue>Something about <code>perf</code> to the rescue<a href=#something-about-perf-to-the-rescue class=hash-link aria-label="Direct link to something-about-perf-to-the-rescue" title="Direct link to something-about-perf-to-the-rescue">​</a></h2>
<p><code>perf record -o dwebp.data -- dwebp ~/3.webp -o /dev/null</code></p>
<p><code>perf record -o cwebp.data -- cwebp ~/PNG_Test.png -o /dev/null</code></p>
<p>Let's look at <code>dwebp</code> first with <code>perf report -i dwebp.data</code>.</p>
<p><img decoding=async loading=lazy alt="Perf report dwebp" src=/assets/images/perf_report_dwebp_png-c0f9529294b3efe6743a980866abdf15.webp width=1254 height=676 class=img_ev3q></p>
<p>Well god damn, literally all of our time is being spent in <code>libz.so</code> it's no wonder our compiler optimizations were hardly improving performance.</p>
<p>Let's also look at the <code>cwebp</code> report, we've generally been getting better results from it.</p>
<p><img decoding=async loading=lazy alt="Perf report cwebp" src=/assets/images/perf_report_cwebp_png-baafb78e8e4527d10a5a1ded232c2bde.webp width=1254 height=676 class=img_ev3q></p>
<p>Okay, much more of our time is being spent in <code>libwebp.so</code> itself here which helps to explain why we were seeing a better performance uplift. Still 5.68% of our time is being spent in <code>libz</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=choosing-wisely>Choosing Wisely<a href=#choosing-wisely class=hash-link aria-label="Direct link to Choosing Wisely" title="Direct link to Choosing Wisely">​</a></h2>
<p>You may remember early on, when I said we are also indirectly testing <code>libpng</code>. Well... after some more digging, that's exactly what's happening here. Re-running the <code>dwebp</code> binary it says this</p>
<blockquote>
<p>Decodes the WebP image file to PNG format</p>
</blockquote>
<p>Turns out, it's more accurate to say we are <em>directly</em> testing <code>libpng</code> and by extension <code>zlib</code>. It isn't <code>libwebp</code> that's spending all of its time in <code>libz.so</code>, it's <code>libpng</code>! This is exactly the reason you have to be careful about the benchmarks chosen and, ensure you understand what they're doing.</p>
<p>However, the good news about this little snafu is:</p>
<ol>
<li><code>dwebp</code> can be used to translate to another image format such as <code>.yuv</code> that'll more accurately remove the bottleneck from <code>libz.so</code>.</li>
<li>We now know that <code>libpng</code> has a huge bottleneck in <code>libz.so</code> and speeding up <code>zlib</code> <em>should</em> dramatically speed up <code>libpng</code> performance.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=adjusting-the-benchmark>Adjusting the Benchmark<a href=#adjusting-the-benchmark class=hash-link aria-label="Direct link to Adjusting the Benchmark" title="Direct link to Adjusting the Benchmark">​</a></h2>
<p>After reverting the <code>libwebp</code> package to the baseline let's use our adjusted decoding benchmark.</p>
<p>We'll now use <code>dwebp ~/3.webp -yuv -o /dev/null</code> for a decoding test, let's run that with <code>perf</code> to ensure we're exclusively testing <code>libwebp.so</code> here.</p>
<p><img decoding=async loading=lazy alt="Perf report dwebp to yuv" src=/assets/images/perf_report_dwebp_yuv-36ad3f6052746d5ea55acce6cbe72b6f.webp width=1254 height=676 class=img_ev3q></p>
<p>Okay that's awesome, no <code>libpng.so</code> or <code>libz.so</code> to mess with our tests!</p>
<p>Let's reapply our optimizations, keeping those which apply an uplift</p>
<table><thead><tr><th>Optimization<th>Decode<th>Size<tbody><tr><td>Baseline<td>14.7 ms<td>1.33 MB<tr><td>Speed<td>14.5 ms<td>1.56 MB<tr><td>LTO<td>14.6 ms<td>1.40 MB<tr><td>PGO<td>18.0 ms <!-- -->⚠️<td>1.07 MB<tr><td>x86-64-v3<td>12.7 ms<td>2.35 MB<tr><td>Speed + LTO + x86-64-v3<td>12.3 ms<td>3.17 MB</table>
<p>Okay, this is great, whilst we aren't getting much from speed or LTO, we are getting a big uplift from x86-64-v3 libraries and when combined with the other optimizations we're getting an uplift in performance of around ~16% at the cost of close to thrice the installed package size.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=partial-profiling>Partial Profiling<a href=#partial-profiling class=hash-link aria-label="Direct link to Partial Profiling" title="Direct link to Partial Profiling">​</a></h3>
<p>Once again we see that PGO regresses performance hard, however, that smaller size is giving a good hint! We already know that the profiling workload we gave it isn't very comprehensive due to the bunch of <code>-Wmissing-profile</code> warnings we get during the optimized build. By default, PGO will aggressively inline and apply additional optimizations to code that's part of the profiling workload while everything else will be optimized for size. The idea being, hot-path code is fast and code that doesn't matter is small. However, what happens when you can't craft a comprehensive workload, as seems to be the case here? Luckily GCC has a flag for exactly that <code>-fprofile-partial-training</code>. GCC docs state that:</p>
<blockquote>
<p>In some cases it is not practical to train all possible hot paths in the program. (For example, program may contain functions specific for a given hardware and training may not cover all hardware configurations program is run on.) With -fprofile-partial-training profile feedback will be ignored for all functions not executed during the train run leading them to be optimized as if they were compiled without profile feedback. This leads to better performance when train run is not representative but also leads to significantly bigger code.</p>
</blockquote>
<p>Okay, let's try it out, all we need to do is specify in our <code>package.yml</code> recipe.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>environment</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    if [[ -n ${PGO_USE_BUILD} ]]; then</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        export CFLAGS="${CFLAGS} -fprofile-partial-training"</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        export CXXFLAGS="${CXXFLAGS} -fprofile-partial-training"</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    fi</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>And the results:</p>
<table><thead><tr><th>Optimization<th>Decode<th>Size<tbody><tr><td>Speed + LTO + x86-64-v3<td>12.3 ms<td>3.17 MB<tr><td>Speed + LTO + x86-64-v3 + Partial PGO<td>12.5 ms<td>3.13 MB</table>
<p>Well, it was worth a try. This highlights how useless PGO can be when you don't or can't provide it a good workload. Interestingly, we don't get the size bloat that was promised, in fact, the opposite.</p>
<h1>Final libwebp Results</h1>
<table><thead><tr><th>Benchmark<th>Time Before<th>Time After<th>Size Before<th>Size After<tbody><tr><td>"dwebp ~/3.webp -yuv -o /dev/null"<td>14.5 ms<td>12.3 ms<td>1.33 MB<td>3.17 MB<tr><td>"cwebp ~/PNG_Test.png -o /dev/null"<td>1.399 s<td>1.313 s<td>--<td>--</table>
<p>In the end, we get a very healthy ~16% improvement in decoding from a .webp to .yuv file. As well as a respectable 6% improvement in encoding from a .png to .webp file. However, the increased package size is very unfortunate. It's possible to tweak the x86-64-v3 build and only ship the libs that actually improve performance in order to get the installed size back to an acceptable level.</p>
<h1>"Next-Generation" Side Quest</h1>
<p>Now, you probably remember earlier due to our unrepresentative benchmark we found out that <code>libpng</code> is getting highly bottlenecked by <code>libz.so</code>. This now seems like a perfect opportunity to take a look at zlib and circle-back to our original benchmark that we were using.</p>
<p>Zlib is widely employed throughout the ecosystem and, as such you'd think it would be highly-optimized for performance. However, that isn't really the case. Zlib is written in an old-fashioned way of C and tries to be <em>extremely</em> portable; supporting dozens of systems that have fallen out of common use. As such, it's hard to apply architecture specific optimizations that wouldn't break some old system or without introducing code spaghetti. There have been a couple of attempts to merge AArch64 and x86_64 optimizations into the canonical zlib library without success.</p>
<p>However, there is some light in this tunnel as various forks of zlib having been popping up, applying new optimizations on top of zlib. The most promising of these looks be to <a href=https://github.com/zlib-ng/zlib-ng/ target=_blank rel="noopener noreferrer">zlib-ng</a>. When built in compatible mode, it promises to be API compatible with canonical zlib and <em>tries</em> to be as ABI compatible as possible.</p>
<p>Let's just go for it, replacing Solus' <code>zlib</code> package with zlib-ng built in compatible mode. It's a bit scary due to how integral zlib is in a typical Linux install, but, how hard could it be?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=i-zee-a-purty-lil-package>I Zee a Purty lil' Package<a href=#i-zee-a-purty-lil-package class=hash-link aria-label="Direct link to I Zee a Purty lil' Package" title="Direct link to I Zee a Purty lil' Package">​</a></h2>
<p>Well that was simple. Here's what our zlib-ng <code>package.yml</code> recipe looks like.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>name</span><span class="token plain">       </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> zlib</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>version</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 2.1.5</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>release</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>28</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>source</span><span class="token plain">     </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token key atrule" style=color:#00a4db>https://github.com/zlib-ng/zlib-ng/archive/refs/tags/2.1.5.tar.gz</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 3f6576971397b379d4205ae5451ff5a68edf6c103b2f03c4188ed7075fbb5f04</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>homepage</span><span class="token plain">   </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> https</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">//github.com/zlib</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">ng/zlib</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">ng</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>license</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> ZLIB</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>component</span><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> system.base</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>summary</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> zlib replacement with optimizations for next generation systems.</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>description</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> A zlib data compression library for the next generation systems. ABI/API compatible mode.</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>devel</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> yes</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>emul32</span><span class="token plain">     </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> yes</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>setup</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %cmake_ninja \</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        -DZLIB_COMPAT=ON \</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        -DWITH_GTEST=OFF \</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        -DBUILD_SHARED_LIBS=ON \</span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>        -DINSTALL_LIB_DIR=%libdir%</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>build</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %ninja_build</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>install</span><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %ninja_install</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>check</span><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>|</span><span class="token scalar string" style=color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token scalar string" style=color:#e3116c>    %ninja_check</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>After building it, all the files seem to be in the right place and the test suite is passing. Let's just install it overwriting our canonical <code>zlib</code> package and hope our system doesn't die... I think the word is YOLO.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">$ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):     198.6 ms ±   2.3 ms    [User: 194.3 ms, System: 3.6 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):   196.3 ms … 203.3 ms    14 runs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ sudo eopkg it zlib-2.1.5-28-1-x86_64.eopkg</span><br></span><span class=token-line style=color:#393A34><span class="token plain">...</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$ $ hyperfine "dwebp ~/3.webp -o /dev/null"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Benchmark 1: dwebp ~/3.webp -o /dev/null</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Time (mean ± σ):      87.6 ms ±   0.7 ms    [User: 84.7 ms, System: 2.6 ms]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Range (min … max):    86.5 ms …  88.7 ms    33 runs</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Well, hot diggity damn. Swapping out the zlib package for a more performant variant has instantly more than halved(!!) our decoding time.</p>
<p>We need to find a more contained <code>libpng</code> benchmark here that removes the <code>libwebp</code> stuff to really confirm the findings here. After some sleuthing the <code>libpng</code> source repository has a <a href=https://github.com/glennrp/libpng/blob/libpng16/contrib/examples/pngtopng.c target=_blank rel="noopener noreferrer">pngtopng.c</a> file we can compile to use the system libpng library.</p>
<p>Changing the header from <code>#include "../../png.h"</code> to <code>#include &lt;png.h></code> then running <code>gcc -Ofast pngtopng.c -lpng16 -o pngtopng</code> to compile it, we have a libpng benchmark. We can reuse our test .png file from earlier. Ending up with: <code>./pngtopng ~/PNG_Test.png /dev/null</code> for our benchmark.</p>
<table><thead><tr><th>Library<th>Time<tbody><tr><td>zlib (canonical)<td>1.464 s<tr><td>zlib-ng (compat)<td>896.6 ms</table>
<p>Well. This is pretty much inline with our flawed <code>dwebp</code> benchmark from earlier. Swapping out zlib almost halves <code>libpng</code> decoding time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=squeezing-more-from-zlib-ng>Squeezing more from zlib-ng<a href=#squeezing-more-from-zlib-ng class=hash-link aria-label="Direct link to Squeezing more from zlib-ng" title="Direct link to Squeezing more from zlib-ng">​</a></h2>
<p>However, we're not done yet. We still have our compiler optimizations available to us to squeeze more performance from <code>zlib-ng</code>.</p>
<table><thead><tr><th>Optimization<th>Decode<th>Size<tbody><tr><td>Baseline<td>896.6 ms<td>141.00 KB<tr><td>Speed<td>883.6 ms<td>182.00 KB<tr><td>LTO<td>892.7 ms<td>133.00 KB<tr><td>PGO<td>894.6 ms<td>141.00 KB<tr><td>x86-64-v3<td>892.5 ms<td>295.00 KB<tr><td>Speed + LTO<td>882.6 ms<td>170.00 KB<tr><td>Speed + LTO + PGO + x86-64-v3<td>882.5 ms<td>250.00 KB</table>
<p>It looks like in this case the simple speed + LTO optimizations is the way to go. Speed gives the majority of the speedup but LTO helps bring back down the package size again. However, it's only a 1.5% improvement from baseline for this benchmark. We can always re-benchmark it later, testing zlib performance more directly instead of via libpng. It shows how good a job the zlib-ng developers have done that it's so performant right out of the gate.</p>
<h1>Final Words</h1>
<p>We've shown the process of how a package can be optimized in Solus, through the failings and wins here I hope some good tips and tricks were provided in avoiding common pitfalls. Additional benchmarking strategies such as BOLT or Polly optimizations were not discussed and it'll be good material for a future blog post.</p>
<p>Some other important things such as tweaking the system for benchmarking in order to get representative and consistent results were also not discussed. This is especially important in power budget constrained systems such as laptops and worth bearing in mind.</p>
<p>Regardless, I hope the story of how <code>libwebp</code> was optimized for was entertaining and some things were learnt for anyone looking to optimize packages in Solus for the future.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/pgo>pgo</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/lto>lto</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/solus>solus</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/packaging>packaging</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/optimization>optimization</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/3>3</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/clang>clang</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/gnu>gnu</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/llvm>llvm</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/glibc>glibc</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/hwcaps>hwcaps</a><li class=tag_QGVx><a class="tag_zVej tagRegular_sFm0" href=/blog/tags/x-86-64-v-3>x86_64-v3</a></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/blog/clean-clean-clean><div class=pagination-nav__sublabel>Newer Post</div><div class=pagination-nav__label>Clean, clean, clean!</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/don't-call-me-mate-pal"><div class=pagination-nav__sublabel>Older Post</div><div class=pagination-nav__label>Don't call me MATE, pal!</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#lets-start-obvious class="table-of-contents__link toc-highlight">Let's Start Obvious</a><li><a href=#pgo-is-great-except-when-it-isnt class="table-of-contents__link toc-highlight">PGO is great, except, when it isn't.</a><li><a href=#256-vector-units-go-brrrrrr class="table-of-contents__link toc-highlight">256 Vector Units go brrrrrr...</a><li><a href=#something-about-perf-to-the-rescue class="table-of-contents__link toc-highlight">Something about <code>perf</code> to the rescue</a><li><a href=#choosing-wisely class="table-of-contents__link toc-highlight">Choosing Wisely</a><li><a href=#adjusting-the-benchmark class="table-of-contents__link toc-highlight">Adjusting the Benchmark</a><ul><li><a href=#partial-profiling class="table-of-contents__link toc-highlight">Partial Profiling</a></ul><li><a href=#i-zee-a-purty-lil-package class="table-of-contents__link toc-highlight">I Zee a Purty lil' Package</a><li><a href=#squeezing-more-from-zlib-ng class="table-of-contents__link toc-highlight">Squeezing more from zlib-ng</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Docs</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/docs/user/intro>Users</a><li class=footer__item><a class=footer__link-item href=/docs/packaging>Packaging</a></ul></div><div class="col footer__col"><div class=footer__title>News</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://getsol.us/blog target=_blank rel="noopener noreferrer" class=footer__link-item>Solus Blog</a><li class=footer__item><a class=footer__link-item href=/blog>Solus Devlog</a></ul></div><div class="col footer__col"><div class=footer__title>Community</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://discuss.getsol.us target=_blank rel="noopener noreferrer" class=footer__link-item>Forums<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://matrix.to/#/#solus:matrix.org target=_blank rel="noopener noreferrer" class=footer__link-item>Matrix<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://fosstodon.org/@Solus target=_blank rel=me class=footer__link-item>Mastodon<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>More</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://getsol.us/ target=_blank rel="noopener noreferrer" class=footer__link-item>Solus Homepage</a><li class=footer__item><a href=https://github.com/getsolus target=_blank rel=me class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://dev.getsol.us target=_blank rel="noopener noreferrer" class=footer__link-item>Packages<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://issues.getsol.us target=_blank rel="noopener noreferrer" class=footer__link-item>Issue Tracker<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/getsolus/packages/blob/main/SECURITY.md target=_blank rel="noopener noreferrer" class=footer__link-item>Security<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025 Solus Project. Built with Docusaurus.</div></div></div></footer></div>